<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wordle Filter — Safe Build</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --accent:#22d3ee;
      --key-bg:#111826; --key-border:#1f2937; --key-text:#e5e7eb;
      --good:#22c55e; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#0b1023);color:var(--text);font:16px/1.5 system-ui}
    header{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,var(--panel),#0e152c);border:1px solid #1f2937;border-radius:14px}
    .card .body{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(13,1fr);gap:6px;margin-top:8px}
    .key{padding:8px 0;border-radius:8px;background:var(--key-bg);border:1px solid var(--key-border);cursor:pointer;color:var(--key-text);font-weight:700;text-transform:uppercase;text-align:center}
    .key.active-inc{background:rgba(34,197,94,.18);border-color:var(--good)}
    .key.active-exc{background:rgba(239,68,68,.18);border-color:var(--bad)}
    .tabs{display:flex;border-bottom:1px solid #1f2937}
    .tab{padding:8px 10px;cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{border-color:var(--accent);color:var(--accent)}
    ul.words{list-style:none;margin:0;padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
    ul.words li{background:#0b1227;border:1px solid #1f2937;border-radius:10px;padding:10px 12px;text-transform:uppercase;text-align:center}
    .input{background:#0b1227;border:1px solid #334155;color:var(--text);padding:9px 10px;border-radius:10px;min-width:200px}
    #dbg{position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:8px;font:12px monospace;color:#9ef}
    .warn{color:#facc15}
  </style>
</head>
<body>
  <header>
    <b>Wordle Filter — Safe Build</b>
    <span id="status" style="margin-left:auto;font:12px monospace;color:#9ef">booting…</span>
  </header>

  <main>
    <section class="card">
      <div class="body">
        <h3>1) Dictionary</h3>
        <input id="file" type="file" accept=".csv,.txt">
        <button id="useSample">Use sample</button>
        <div class="warn" style="margin-top:6px">If no CSV found, sample words should appear.</div>
        <hr style="border-color:#1f2937">
        <h3>2) Global filters</h3>
        <div>Include</div><div id="g-include" class="grid"></div>
        <div style="margin-top:6px">Exclude</div><div id="g-exclude" class="grid"></div>
        <hr style="border-color:#1f2937">
        <h3>3) Position</h3>
        <div id="tabs" class="tabs"></div>
        <div>Include @ pos</div><div id="p-include" class="grid"></div>
        <div style="margin-top:6px">Exclude @ pos</div><div id="p-exclude" class="grid"></div>
      </div>
    </section>

    <section class="card" style="grid-row: span 2">
      <div class="body" style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1f2937">
        <div><b><span id="count">0</span> matches</b></div>
        <div><input id="searchBox" class="input" placeholder="contains…"> <button id="downloadCsv">Download CSV</button></div>
      </div>
      <ul id="words" class="words"></ul>
    </section>
  </main>

  <div id="dbg"></div>

  <script>
  (function(){
    const dbg = (msg) => { const el = document.getElementById('dbg'); if (el) { el.textContent = msg; } console.log('[DBG]', msg); };
    const setStatus = (t) => { const s=document.getElementById('status'); if(s) s.textContent=t; };

    const A2Z = Array.from({length:26}, (_,i)=>String.fromCharCode(97+i));
    const state = {
      words: [], filtered: [], search: "",
      globalInclude: new Set(), globalExclude: new Set(),
      pos: [0,1,2,3,4].map(()=>({ include:new Set(), exclude:new Set() })),
      activePos: 0, autoloadTried: false,
    };
    const SAMPLE = ['cigar','rebut','sissy','humph','awake','blush','focal','evade','naval','serve',
                    'heath','dwarf','model','stare','raise','orate','count','could','cloud','touch',
                    'point','pilot','amino','voice','width','fifth','light','filth','civil','gooey'];

    function parseWordsFromCsvText(text){
      const out=[]; const seen=new Set();
      const lines = text.replace(/^\\uFEFF/, '').split(/\\r?\\n/);
      for(const raw of lines){
        const line=(raw||'').trim(); if(!line) continue;
        const first=line.split(/[\\t,;]+/)[0].trim();
        const m = first.match(/[A-Za-z]{5}/) || line.match(/[A-Za-z]{5}/);
        if(!m) continue; const w=m[0].toLowerCase();
        if(/^[a-z]{5}$/.test(w) && !seen.has(w)){ seen.add(w); out.push(w); }
      }
      return out;
    }

    function buildGrid(rootId, kind){
      const root=document.getElementById(rootId); if(!root){ dbg('missing '+rootId); return; }
      root.innerHTML='';
      A2Z.forEach(ch=>{
        const b=document.createElement('button');
        b.className='key'; b.textContent=ch;
        b.dataset.letter=ch; b.dataset.kind=kind;
        b.addEventListener('click', onKeyClick);
        root.appendChild(b);
      });
    }

    function buildTabs(){
      const tabs=document.getElementById('tabs'); if(!tabs){ dbg('missing tabs'); return; }
      tabs.innerHTML='';
      for(let i=0;i<5;i++){
        const t=document.createElement('div'); t.className='tab'+(i===state.activePos?' active':''); t.textContent=`Pos ${i+1}`;
        t.addEventListener('click', ()=>{ state.activePos=i; updateTabs(); refreshButtonStates(); apply(); });
        tabs.appendChild(t);
      }
    }
    function updateTabs(){
      const tabs=document.querySelectorAll('#tabs .tab');
      tabs.forEach((el,idx)=>el.classList.toggle('active', idx===state.activePos));
    }

    function refreshButtonStates(){
      document.querySelectorAll('#g-include .key').forEach(btn=>{
        const ch=btn.dataset.letter; btn.classList.toggle('active-inc', state.globalInclude.has(ch)); btn.classList.toggle('active-exc', false);
      });
      document.querySelectorAll('#g-exclude .key').forEach(btn=>{
        const ch=btn.dataset.letter; btn.classList.toggle('active-exc', state.globalExclude.has(ch)); btn.classList.toggle('active-inc', false);
      });
      document.querySelectorAll('#p-include .key').forEach(btn=>{
        const ch=btn.dataset.letter; btn.classList.toggle('active-inc', state.pos[state.activePos].include.has(ch)); btn.classList.toggle('active-exc', false);
      });
      document.querySelectorAll('#p-exclude .key').forEach(btn=>{
        const ch=btn.dataset.letter; btn.classList.toggle('active-exc', state.pos[state.activePos].exclude.has(ch)); btn.classList.toggle('active-inc', false);
      });
    }

    function onKeyClick(e){
      const btn=e.currentTarget; const letter=btn.dataset.letter; const kind=btn.dataset.kind; const pos=state.activePos;
      const toggle=(set,other)=>{ if(set.has(letter)) set.delete(letter); else { set.add(letter); other.delete(letter); } };
      if(kind==='g-include') toggle(state.globalInclude, state.globalExclude);
      if(kind==='g-exclude') toggle(state.globalExclude, state.globalInclude);
      if(kind==='p-include') toggle(state.pos[pos].include, state.pos[pos].exclude);
      if(kind==='p-exclude') toggle(state.pos[pos].exclude, state.pos[pos].include);
      refreshButtonStates(); apply();
    }

    function loadWordsFromText(text){ const words=parseWordsFromCsvText(text); loadWordsFromArray(words); }
    function loadWordsFromArray(arr){
      state.words = Array.from(new Set(arr.map(w=>w.toLowerCase()).filter(w=>/^[a-z]{5}$/.test(w))));
      apply();
    }

    async function tryAutoload(){
      if(state.autoloadTried) return; state.autoloadTried = true;
      try{
        setStatus('fetching CSV…');
        const res=await fetch('./wordle_solutions_full.csv', {cache:'no-store'});
        if(!res.ok) throw new Error('CSV not found');
        const text=await res.text();
        const words=parseWordsFromCsvText(text);
        if(!words.length) throw new Error('parsed zero');
        loadWordsFromArray(words);
        setStatus(`loaded ${words.length} words`);
      }catch(err){
        console.warn('autoload fail → sample', err);
        setStatus('using sample');
        loadWordsFromArray(SAMPLE);
      }
    }

    function apply(){
      const out=[]; const GI=state.globalInclude; const GE=state.globalExclude; const P=state.pos; const q=state.search;
      outer: for(const w of state.words){
        if(q && !w.includes(q)) continue;
        for(const ch of GE) if(w.includes(ch)) continue outer;
        for(const ch of GI) if(!w.includes(ch)) continue outer;
        for(let i=0;i<5;i++){
          const inc=P[i].include, exc=P[i].exclude, c=w[i];
          if(inc.size>0 && !inc.has(c)) continue outer;
          if(exc.has(c)) continue outer;
        }
        out.push(w);
      }
      state.filtered=out; renderList();
    }
    function renderList(){
      const ul=document.getElementById('words'); if(!ul){ dbg('missing words'); return; }
      ul.innerHTML='';
      for(const w of state.filtered){ const li=document.createElement('li'); li.textContent=w; ul.appendChild(li); }
      const cnt=document.getElementById('count'); if(cnt) cnt.textContent=state.filtered.length;
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        setStatus('init…');
        buildGrid('g-include','g-include'); buildGrid('g-exclude','g-exclude');
        buildTabs(); buildGrid('p-include','p-include'); buildGrid('p-exclude','p-exclude');
        refreshButtonStates();
        const f=document.getElementById('file'); if(f){ f.addEventListener('change', async (e)=>{
          const ff=e.target.files[0]; if(!ff) return; const text=await ff.text(); loadWordsFromText(text);
        });}
        const us=document.getElementById('useSample'); if(us){ us.addEventListener('click', ()=>loadWordsFromArray(SAMPLE)); }
        const sb=document.getElementById('searchBox'); if(sb){ sb.addEventListener('input', (e)=>{ state.search=e.target.value.trim().toLowerCase(); apply(); }); }
        const dl=document.getElementById('downloadCsv'); if(dl){ dl.addEventListener('click', ()=>{
          const csv=state.filtered.join('\\n'); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='filtered_words.csv'; a.click();
        });}
        setStatus('ready'); tryAutoload(); dbg('init OK');
      }catch(e){ setStatus('init error'); dbg('INIT ERROR: '+(e?.message||e)); }
    });
  })();
  </script>
</body>
</html>
